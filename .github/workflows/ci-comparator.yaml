name: CI / Price comparator

on: 
  pull_request:
    paths:
      - 'pcomparator/**'
  push:
    branches:
      - main
      - dev
    paths:
      - 'pcomparator/**'

defaults:
  run:
    working-directory: pcomparator

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install
        
      - name: Cache turbo build setup
        uses: actions/cache@v4
        with: 
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-
            
      - name: Check coding standards
        run: yarn run format:check
        
      - name: Run ESLint
        run: yarn run lint
        
      - name: TypeScript type checking
        run: yarn run typescript:check
        
      - name: Check for duplicate dependencies
        run: yarn dedupe --check
        
      - name: Check build
        run: yarn build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
  validate-prisma:
    name: Validate Prisma Schema
    runs-on: ubuntu-latest
    needs: [quality]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install
        
      - name: Validate Prisma schema
        run: yarn prisma validate
        
      - name: Check Prisma schema formatting
        run: yarn prisma format --check
        
  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    needs: [quality]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install
        
      - name: Build application
        run: yarn build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
      - name: Check bundle size
        uses: preactjs/compressed-size-action@v2
        with:
          pattern: 'pcomparator/.next/**/*.js'
          strip-hash: true
